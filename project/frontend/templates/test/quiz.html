{% extends "base.html" %}

{% block title %}Royal Chemistry Challenge{% endblock %}

{% block content %}
<div class="royal-quiz-container">
    <div class="royal-quiz-header">
        <h1 class="royal-quiz-title" id="quizTitle">Royal Chemistry Challenge</h1>
        <div class="quiz-meta">
            <div class="quiz-timer">
                <i class="bi bi-clock"></i>
                <span id="time">00:00</span>
            </div>
            <div class="question-count" id="questionCount">Question 1 of 10</div>
        </div>
    </div>
    
    <div class="royal-question-text" id="questionText">
        Loading question...
    </div>

    <div id="optionsContainer">
        <!-- Options will be loaded here -->
    </div>

    <div class="status-bar">
        <div class="status-item status-saved" id="saveStatus">
            <i class="bi bi-check-circle"></i> Saved
        </div>
    </div>

    <div class="royal-progress">
        <div class="royal-progress-bar" id="progressBar" style="width: 0%"></div>
    </div>

    <div class="royal-quiz-footer">
        <button class="btn btn-royal-outline" id="prevBtn" disabled>
            <i class="bi bi-chevron-left me-2"></i> Previous
        </button>
        <div>
            <span class="text-muted me-3">Start Time: <span id="startTime"></span></span>
            <button class="btn btn-outline-secondary" id="saveBtn">
                <i class="bi bi-save me-2"></i> Save Progress
            </button>
        </div>
        <button class="btn btn-royal" id="nextBtn">
            Next <i class="bi bi-chevron-right ms-2"></i>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize quiz state
    const quizState = {
        currentQuestionIndex: 0,
        questions: [],
        answers: {},
        timer: null,
        timeLeft: 0, // in seconds
        testId: null,
        subject: null,
        difficulty: null
    };
    
    // Load test parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    quizState.subject = urlParams.get('subject');
    quizState.difficulty = urlParams.get('difficulty');
    
    if (!quizState.subject || !quizState.difficulty) {
        alert('Invalid test parameters');
        window.location.href = '/test/select';
        return;
    }
    
    // Start the test
    await startTest(quizState);
    
    // Event listeners
    document.getElementById('prevBtn').addEventListener('click', () => {
        if (quizState.currentQuestionIndex > 0) {
            quizState.currentQuestionIndex--;
            displayQuestion(quizState);
        }
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
        if (quizState.currentQuestionIndex < quizState.questions.length - 1) {
            quizState.currentQuestionIndex++;
            displayQuestion(quizState);
        } else {
            submitTest(quizState);
        }
    });
    
    document.getElementById('saveBtn').addEventListener('click', () => {
        saveProgress(quizState);
    });
});

async function startTest(quizState) {
    try {
        // Show loading state
        document.getElementById('questionText').textContent = 'Loading questions...';
        document.getElementById('optionsContainer').innerHTML = '';
        
        // Start timer (30 minutes)
        quizState.timeLeft = 30 * 60;
        updateTimerDisplay(quizState);
        quizState.timer = setInterval(() => {
            quizState.timeLeft--;
            updateTimerDisplay(quizState);
            
            if (quizState.timeLeft <= 0) {
                clearInterval(quizState.timer);
                alert('Time is up! Your test will be submitted automatically.');
                submitTest(quizState);
            }
        }, 1000);
        
        // Record start time
        const now = new Date();
        document.getElementById('startTime').textContent = now.toLocaleTimeString();
        
        // Load questions from API
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/test/questions?subject=${quizState.subject}&difficulty=${quizState.difficulty}&limit=10`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load questions');
        
        quizState.questions = await response.json();
        
        // Initialize test on server
        const testResponse = await fetch('/test/start', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                subject: quizState.subject,
                difficulty: quizState.difficulty,
                question_count: quizState.questions.length
            })
        });
        
        if (!testResponse.ok) throw new Error('Failed to start test');
        
        const testData = await testResponse.json();
        quizState.testId = testData.test_id;
        
        // Display first question
        displayQuestion(quizState);
    } catch (error) {
        console.error('Error starting test:', error);
        alert(error.message);
        window.location.href = '/test/select';
    }
}

function displayQuestion(quizState) {
    const question = quizState.questions[quizState.currentQuestionIndex];
    
    // Update question text
    document.getElementById('questionText').innerHTML = `<strong>${question.text}</strong>`;
    
    // Update question count
    document.getElementById('questionCount').textContent = 
        `Question ${quizState.currentQuestionIndex + 1} of ${quizState.questions.length}`;
    
    // Update progress bar
    const progress = ((quizState.currentQuestionIndex + 1) / quizState.questions.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
    
    // Render options
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = `royal-option ${quizState.answers[question.id] === option.id ? 'selected' : ''}`;
        optionDiv.innerHTML = `
            <div class="option-number">${index + 1}</div>
            <div class="option-text">${option.text}</div>
        `;
        
        optionDiv.addEventListener('click', () => {
            // Remove selected class from all options
            document.querySelectorAll('.royal-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            optionDiv.classList.add('selected');
            
            // Save answer
            quizState.answers[question.id] = option.id;
            
            // Update save status
            document.getElementById('saveStatus').innerHTML = 
                '<i class="bi bi-exclamation-circle"></i> Not Saved';
        });
        
        optionsContainer.appendChild(optionDiv);
    });
    
    // Update navigation buttons
    document.getElementById('prevBtn').disabled = quizState.currentQuestionIndex === 0;
    document.getElementById('nextBtn').textContent = 
        quizState.currentQuestionIndex === quizState.questions.length - 1 ? 
        'Submit Test' : 'Next <i class="bi bi-chevron-right ms-2"></i>';
}

function updateTimerDisplay(quizState) {
    const minutes = Math.floor(quizState.timeLeft / 60);
    const seconds = quizState.timeLeft % 60;
    document.getElementById('time').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

async function saveProgress(quizState) {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/test/${quizState.testId}/progress`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_question: quizState.currentQuestionIndex,
                answers: quizState.answers
            })
        });
        
        if (!response.ok) throw new Error('Failed to save progress');
        
        // Update save status
        document.getElementById('saveStatus').innerHTML = 
            '<i class="bi bi-check-circle-fill"></i> Saved';
    } catch (error) {
        console.error('Error saving progress:', error);
        alert('Failed to save progress. Please try again.');
    }
}

async function submitTest(quizState) {
    if (!confirm('Are you sure you want to submit your test?')) return;
    
    try {
        clearInterval(quizState.timer);
        
        // Calculate score
        const correctAnswers = quizState.questions.reduce((count, question) => {
            const selectedOptionId = quizState.answers[question.id];
            if (!selectedOptionId) return count;
            
            const selectedOption = question.options.find(opt => opt.id === selectedOptionId);
            return count + (selectedOption && selectedOption.is_correct ? 1 : 0);
        }, 0);
        
        const score = (correctAnswers / quizState.questions.length) * 100;
        const timeTaken = (30 * 60) - quizState.timeLeft;
        
        // Submit to server
        const token = localStorage.getItem('access_token');
        const response = await fetch('/test/submit', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                test_id: quizState.testId,
                score: score,
                correct_answers: correctAnswers,
                total_questions: quizState.questions.length,
                time_taken: timeTaken,
                answers: quizState.answers
            })
        });
        
        if (!response.ok) throw new Error('Failed to submit test');
        
        // Redirect to results page
        const result = await response.json();
        window.location.href = `/test/result?id=${result.test_id}`;
    } catch (error) {
        console.error('Error submitting test:', error);
        alert('Failed to submit test. Please try again.');
    }
}
</script>
{% endblock %}